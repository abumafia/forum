<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto p-6">
    <!-- Header -->
    <h1 class="text-3xl font-bold text-center mb-8 text-indigo-600">📝 Mini Forum</h1>

    <!-- Create Post Button -->
    <div class="text-center mb-6">
      <button onclick="openPostModal()"
        class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-700 transition">
        ➕ Create Post
      </button>
    </div>

    <!-- Posts -->
    <h2 class="text-2xl font-semibold mb-4">Latest Posts</h2>
    <div id="posts" class="space-y-6"></div>
  </div>

  <!-- Post Modal -->
  <div id="postModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 relative">
      <button onclick="closePostModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black">✖</button>
      <h2 class="text-xl font-semibold mb-4">Create a Post</h2>
      <form id="postForm" class="space-y-3">
        <input type="text" id="author" placeholder="Your name" required
          class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-indigo-300">
        <input type="text" id="title" placeholder="Title" required
          class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-indigo-300">
        <textarea id="content" placeholder="Write something..." required
          class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-indigo-300"></textarea>
        <button type="submit"
          class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Post</button>
      </form>
    </div>
  </div>

  <!-- Replies Modal -->
  <div id="repliesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-xl p-6 relative max-h-[80vh] overflow-y-auto">
      <button onclick="closeRepliesModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black">✖</button>
      <h2 id="repliesTitle" class="text-xl font-semibold mb-4">Replies</h2>
      <ul id="repliesList" class="space-y-2 mb-4"></ul>
      <form id="replyForm" class="space-y-3">
        <input type="hidden" id="replyPostId">
        <input type="text" id="replyAuthor" placeholder="Your name" required
          class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-indigo-300">
        <input type="text" id="replyText" placeholder="Reply..." required
          class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-indigo-300">
        <button type="submit"
          class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">Add Reply</button>
      </form>
    </div>
  </div>

  <script>
    const postsDiv = document.getElementById("posts");
    const repliesModal = document.getElementById("repliesModal");
    const repliesList = document.getElementById("repliesList");
    const repliesTitle = document.getElementById("repliesTitle");

    // Modal functions
    function openPostModal() {
      document.getElementById("postModal").classList.remove("hidden");
    }
    function closePostModal() {
      document.getElementById("postModal").classList.add("hidden");
    }
    function openRepliesModal(post) {
      document.getElementById("replyPostId").value = post._id;
      repliesTitle.innerText = `Replies to: ${post.title}`;
      repliesList.innerHTML = post.replies.length > 0
        ? post.replies.map(r => `<li class="bg-gray-100 px-3 py-2 rounded-md"><b>${r.author}:</b> ${r.text}</li>`).join("")
        : `<li class="text-gray-400">No replies yet</li>`;
      repliesModal.classList.remove("hidden");
    }
    function closeRepliesModal() {
      repliesModal.classList.add("hidden");
    }

    // Load posts
    async function loadPosts() {
      const res = await fetch("/api/posts");
      const posts = await res.json();
      postsDiv.innerHTML = "";
      posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "bg-white shadow-md rounded-xl p-5";
        div.innerHTML = `
          <h3 class="text-lg font-bold text-indigo-700">${post.title}</h3>
          <p class="text-gray-600 mb-2">by <span class="font-semibold">${post.author}</span></p>
          <p class="mb-4">${post.content}</p>
          <button onclick='openRepliesModal(${JSON.stringify(post)})'
            class="bg-green-500 text-white px-4 py-1 rounded-lg hover:bg-green-600 transition">
            💬 View Replies (${post.replies.length})
          </button>
        `;
        postsDiv.appendChild(div);
      });
    }

    // Post form submit
    document.getElementById("postForm").addEventListener("submit", async e => {
      e.preventDefault();
      const author = document.getElementById("author").value;
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;
      await fetch("/api/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ author, title, content }),
      });
      e.target.reset();
      closePostModal();
      loadPosts();
    });

    // Reply form submit
    document.getElementById("replyForm").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("replyPostId").value;
      const author = document.getElementById("replyAuthor").value;
      const text = document.getElementById("replyText").value;
      await fetch(`/api/posts/${id}/reply`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ author, text }),
      });
      e.target.reset();
      // refresh modal replies
      const res = await fetch(`/api/posts`);
      const posts = await res.json();
      const updatedPost = posts.find(p => p._id === id);
      openRepliesModal(updatedPost);
      loadPosts();
    });

    loadPosts();
  </script>
</body>
</html>
